org: amirykehara  #-> Your Serverless Framework Org
service: cliente-ms

provider:
  name: aws
  runtime: python3.13
  region: us-east-1
  memorySize: 256
  timeout: 15
  iam:
    role: arn:aws:iam::773506457076:role/LabRole  #-> Your IAM Role ARN (agrega permisos para EventBridge y StepFunctions si no los tiene)
  environment:
    CUSTOMERS_TABLE: CustomersTable
    ORDERS_TABLE: OrdersTable
    STEPS_TABLE: StepsTable  # Nueva
    EVENT_BUS_NAME: PardosEventBus  # Nuevo

functions:
  createOrder:
    handler: handler.create_order
    events:
      - httpApi:
          path: /orders
          method: post
  getOrdersByCustomer:
    handler: handler.get_orders_by_customer
    events:
      - httpApi:
          path: /orders/{customerId}
          method: get
  createCustomer:
    handler: handler.create_customer
    events:
      - httpApi:
          path: /customers
          method: post
  getCustomer:
    handler: handler.get_customer
    events:
      - httpApi:
          path: /customers/{customerId}
          method: get
  # Nuevas funciones para Step Functions
  processCooking:
    handler: handler.process_cooking
  processPackaging:
    handler: handler.process_packaging
  processDelivery:
    handler: handler.process_delivery
  processDelivered:
    handler: handler.process_delivered

resources:
  Resources:
    # Tablas existentes
    CustomersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: CustomersTable
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: OrdersTable
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    # Nueva tabla para steps
    StepsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: StepsTable
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    # Nuevo: EventBus (EventBridge)
    PardosEventBus:
      Type: AWS::Events::EventBus
      Properties:
        Name: PardosEventBus

    # Nuevo: Rule para trigger Step Functions desde OrderCreated
    OrderCreatedRule:
      Type: AWS::Events::Rule
      Properties:
        EventBusName: !Ref PardosEventBus
        EventPattern:
          source: ["pardos.orders"]
          detail-type: ["OrderCreated"]
        State: ENABLED
        Targets:
          - Arn: !Ref OrderWorkflowStateMachine  # Apunta al State Machine
            RoleArn: !GetAtt StepFunctionsExecutionRole.Arn  # Rol para ejecutar

    # Nuevo: State Machine para Step Functions
    # Nuevo: State Machine para Step Functions
    OrderWorkflowStateMachine:
      Type: AWS::StepFunctions::StateMachine
      Properties:
        StateMachineName: OrderWorkflow
        DefinitionString: !Sub |
          {
            "Comment": "Workflow para procesar pedidos: CREATED -> COOKING -> PACKAGING -> DELIVERY -> DELIVERED",
            "StartAt": "Cooking",
            "States": {
              "Cooking": {
                "Type": "Task",
                "Resource": "${ProcessCookingLambdaFunction.Arn}",
                "Next": "Packaging"
              },
              "Packaging": {
                "Type": "Task",
                "Resource": "${ProcessPackagingLambdaFunction.Arn}",
                "Next": "Delivery"
              },
              "Delivery": {
                "Type": "Task",
                "Resource": "${ProcessDeliveryLambdaFunction.Arn}",
                "Next": "Delivered"
              },
              "Delivered": {
                "Type": "Task",
                "Resource": "${ProcessDeliveredLambdaFunction.Arn}",
                "End": true
              }
            }
          }
        RoleArn: !GetAtt StepFunctionsExecutionRole.Arn
    # Rol para Step Functions (permisos para invocar Lambdas y acceder DynamoDB/EventBridge)
    StepFunctionsExecutionRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: states.amazonaws.com
              Action: sts:AssumeRole
        Path: "/"
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSLambdaRole
          - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess  # Para acceso a tablas
          - arn:aws:iam::aws:policy/AmazonEventBridgeFullAccess  # Para put_events

#plugins:
  #- serverless-python-requirements  # Si necesitas paquetes extras, agr√©galo
custom:
  pythonRequirements:
    dockerizePip: true
    usePoetry: false
